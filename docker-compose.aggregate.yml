version: "3.8"

# Aggregator compose: a convenience file that replicates the component services
# but marks them with the `full` profile so you can start the whole stack
# with a single command while keeping component-local compose files unchanged.

services:
  mlflow:
    profiles: ["full"]
    build:
      context: ./mlflow
      dockerfile: Dockerfile
    image: mlflow-server:local
    ports:
      - "5000:5000"
    environment:
      - BACKEND_URI=${BACKEND_URI}
      - ARTIFACT_ROOT=${ARTIFACT_ROOT}
      - PORT=5000
    volumes:
      - ./mlflow/data:/mlflow
    restart: unless-stopped

  triton:
    profiles: ["full"]
    build:
      context: ./triton
      dockerfile: Dockerfile
      args:
        - BASE_IMAGE=${TRITON_BASE_IMAGE:-nvcr.io/nvidia/tritonserver:23.05-py3}
    image: triton-local:latest
    ports:
      - "8000:8000"
      - "8001:8001"
      - "8002:8002"
    volumes:
      - ./triton/models:/models:ro
    restart: unless-stopped
    environment:
      - TRITON_MODEL_REPOSITORY=/models
